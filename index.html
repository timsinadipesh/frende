<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>frende</title>
<style>
  :root {
    --bg-color: #ffffff;
    --text-color: #000000;
    --panel-bg: #f8f8f8;
    --message-human: rgba(0,0,0,0.1);
    --message-ai: rgba(0,0,0,0.05);
  }
  [data-theme="dark"] {
    --bg-color: #121212;
    --text-color: #ffffff;
    --panel-bg: #1e1e1e;
    --message-human: rgba(255,255,255,0.25);
    --message-ai: rgba(0,0,0,0.25);
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg-color);
    color: var(--text-color);
  }

  /* Top Bar */
  .top-bar {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--panel-bg);
  }
  .left-group {
    display: flex;
    align-items: center;
    gap: 10px;
    justify-self: start;
  }
  .brand {
    font-weight: 700;
    font-size: 1.25rem;
    letter-spacing: .4px;
    justify-self: center;
    user-select: none;
  }
  .right-group { 
    justify-self: end; 
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .lang-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
    background: var(--bg-color);
    color: var(--text-color);
    transition: all .15s ease;
    font-weight: 600;
    letter-spacing: .3px;
    white-space: nowrap;
    position: relative;
  }
  .lang-btn:hover { 
    background: rgba(0,0,0,0.05);
    border-color: rgba(0,0,0,0.2);
  }

  .theme-toggle {
    display: flex;
    gap: 2px;
    background: var(--panel-bg);
    border-radius: 6px;
    padding: 2px;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .theme-btn {
    padding: 4px 8px;
    border: none;
    background: transparent;
    color: var(--text-color);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all .15s ease;
  }

  .theme-btn.active {
    background: var(--bg-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .theme-btn:hover:not(.active) {
    background: rgba(0,0,0,0.05);
  }

  /* Panels */
  .main { flex: 1; display: flex; overflow: hidden; }
  .panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    overflow-y: auto;
    background: var(--bg-color);
    align-items: center;
  }
  .divider { width: 1px; background: rgba(0,0,0,0.1); }

  .message {
    padding: 8px 12px;
    margin: 4px 0;
    border-radius: 16px;
    max-width: 80%;
    line-height: 1.4;
  }
  .from-human { background: var(--message-human); }
  .from-ai { background: var(--message-ai); }

  #typing-area {
    text-align: left;
    padding: 10px;
    outline: none;
    border: none;
    background: transparent;
    color: var(--text-color);
    font-size: 1.1rem;
    min-height: 30px;
    white-space: pre-wrap;
    word-break: break-word;
    width: 100%;
    max-width: 80%;
  }

  .spacer {
    width: 100%;
    max-width: 80%;
  }

  /* Language Modal */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(0,0,0,0.35);
    display: none;
    align-items: center;
    justify-content: center;
  }
  .card {
    width: min(280px, 92vw);
    background: #ffffff;
    color: #000;
    border-radius: 16px;
    padding: 18px 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.25);
  }
  .chips {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .chip {
    padding: 12px 16px;
    text-align: center;
    border-radius: 12px;
    background: #f2f5fb;
    border: 1px solid #e4eaf2;
    cursor: pointer;
    user-select: none;
    font-weight: 600;
    color: #102038;
    transition: background .15s ease, border-color .15s ease, color .15s ease;
  }
  .chip:hover {
    background: #e3e9f3;
    border-color: #c5d1e4;
  }
  .chip.active {
    background: #bbdefb;
    border-color: #2196f3;
    color: #0d47a1;
  }
</style>
</head>
<body>

  <!-- Top Bar -->
  <div class="top-bar">
    <div class="left-group">
      <button id="lang-btn" class="lang-btn" title="Select Language" aria-label="Select Language">
        <span id="selected-lang">EN ↔ DE</span>
      </button>
    </div>
    <div class="brand">frende</div>
    <div class="right-group">
      <div class="theme-toggle">
        <button id="theme-light" class="theme-btn">Light</button>
        <button id="theme-dark" class="theme-btn">Dark</button>
      </div>
    </div>
  </div>

  <!-- Panels -->
  <div class="main">
    <div class="panel" id="left-panel">
      <div id="typing-area" contenteditable="true"></div>
    </div>
    <div class="divider"></div>
    <div class="panel" id="right-panel"></div>
  </div>

  <!-- Language Selection Modal -->
  <div id="lang-modal" class="modal">
    <div class="card">
      <!-- Language chips -->
      <div class="chips" id="lang-chips">
        <div class="chip" data-pair="EN ↔ DE">EN ↔ DE</div>
        <div class="chip" data-pair="DE ↔ FR">DE ↔ FR</div>
        <div class="chip" data-pair="FR ↔ EN">FR ↔ EN</div>
      </div>
    </div>
  </div>

<script>
  const typingArea = document.getElementById('typing-area');
  const leftPanel = document.getElementById('left-panel');
  const rightPanel = document.getElementById('right-panel');
  const langBtn = document.getElementById('lang-btn');
  const selectedLangLabel = document.getElementById('selected-lang');
  const modal = document.getElementById('lang-modal');
  const chips = document.getElementById('lang-chips');
  const themeLightBtn = document.getElementById('theme-light');
  const themeDarkBtn = document.getElementById('theme-dark');

  const API_BASE = 'http://localhost:5000';

  // Updated language pairs for bidirectional translation
  const LANGUAGE_PAIRS = {
    'EN ↔ DE': 'EN ↔ DE',
    'DE ↔ FR': 'DE ↔ FR', 
    'FR ↔ EN': 'FR ↔ EN'
  };

  let currentLangPair = 'EN ↔ DE';

  function getSystemTheme() {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    document.documentElement.dataset.theme = theme;
    
    // Update button states
    themeLightBtn.classList.toggle('active', theme === 'light');
    themeDarkBtn.classList.toggle('active', theme === 'dark');
  }

  // Load saved settings
  function loadSettings() {
    const savedLang = localStorage.getItem('langPair');
    const savedTheme = localStorage.getItem('theme');

    if (savedLang && LANGUAGE_PAIRS[savedLang]) {
      currentLangPair = savedLang;
    }
    selectedLangLabel.textContent = currentLangPair;

    // Use saved theme or default to system theme
    const themeToApply = savedTheme || getSystemTheme();
    applyTheme(themeToApply);

    chips.querySelectorAll('.chip').forEach(chip => {
      chip.classList.toggle('active', chip.dataset.pair === currentLangPair);
    });
  }

  function saveSettings() {
    localStorage.setItem('langPair', currentLangPair);
  }

  function saveTheme(theme) {
    localStorage.setItem('theme', theme);
  }

  function openLangModal() { modal.style.display = 'flex'; }
  function closeLangModal() { 
    modal.style.display = 'none'; 
    typingArea.focus(); 
  }

  langBtn.addEventListener('click', openLangModal);

  // One-click language selection
  chips.addEventListener('click', e => {
    const chip = e.target.closest('.chip');
    if (!chip) return;
    
    chips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    currentLangPair = chip.dataset.pair;
    selectedLangLabel.textContent = currentLangPair;
    saveSettings();
    closeLangModal(); // Auto-close and focus
  });

  // Theme buttons
  themeLightBtn.addEventListener('click', () => {
    applyTheme('light');
    saveTheme('light');
    typingArea.focus();
  });

  themeDarkBtn.addEventListener('click', () => {
    applyTheme('dark');
    saveTheme('dark');
    typingArea.focus();
  });

  modal.addEventListener('click', e => { if (e.target === modal) closeLangModal(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape' && modal.style.display === 'flex') closeLangModal(); });

  window.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    typingArea.focus(); // Auto-focus on page load
  });

  // Sync scrolls
  leftPanel.addEventListener('scroll', () => {
    rightPanel.scrollTop = leftPanel.scrollTop;
  });
  rightPanel.addEventListener('scroll', () => {
    leftPanel.scrollTop = rightPanel.scrollTop;
  });

  // Focus typing area on click anywhere except interactive elements
  document.addEventListener('click', e => {
    if (modal.style.display !== 'flex' &&
        !e.target.closest('button') &&
        !e.target.closest('input') &&
        !e.target.closest('select') &&
        !e.target.closest('.chip') &&
        e.target !== typingArea) {
      typingArea.focus();
    }
  });

  // Updated translation handling with auto-detection
  async function translateText(text, languagePair) {
    try {
      const res = await fetch(`${API_BASE}/translate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          text: text, 
          language_pair: languagePair  // Changed from 'direction'
        })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      
      // Log which direction was actually used
      console.log(`Auto-detected direction: ${data.direction_used}`);
      
      return data.translation;
    } catch (e) {
      console.error(e);
      return `Translation error: ${e.message}`;
    }
  }

  function createSpacer(height) {
    const spacer = document.createElement('div');
    spacer.className = 'spacer';
    spacer.style.height = `${height}px`;
    return spacer;
  }

  function addMessage(text, isHuman = true) {
    const el = document.createElement('div');
    el.className = `message ${isHuman ? 'from-human' : 'from-ai'}`;
    el.textContent = text;
    return el;
  }

  typingArea.addEventListener('keydown', async e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const text = typingArea.innerText.trim();
      if (!text) return;
      
      const humanMessage = addMessage(text, true);
      leftPanel.insertBefore(humanMessage, typingArea);
      typingArea.innerText = '';
      leftPanel.scrollTop = leftPanel.scrollHeight;
      rightPanel.scrollTop = rightPanel.scrollHeight;
      
      // Use the new auto-detection translation
      const translation = await translateText(text, currentLangPair);
      const aiMessage = addMessage(translation, false);
      rightPanel.appendChild(aiMessage);
      
      // Align heights
      const hLeft = humanMessage.offsetHeight;
      const hRight = aiMessage.offsetHeight;
      if (hLeft > hRight) {
        const spacer = createSpacer(hLeft - hRight);
        rightPanel.appendChild(spacer);
      } else if (hRight > hLeft) {
        const spacer = createSpacer(hRight - hLeft);
        leftPanel.insertBefore(spacer, typingArea);
      }
      
      leftPanel.scrollTop = leftPanel.scrollHeight;
      rightPanel.scrollTop = rightPanel.scrollHeight;
    }
  });
</script>

</body>
</html>